# Event-Driven Coordination Framework

**Status**: ‚úÖ Production Ready - Built on existing accountability infrastructure  
**Integration**: Phase 1 completion procedures with real-time event processing  
**Events Source**: `coordination_alerts.json` generated by accountability system

## Framework Overview

The Event-Driven Coordination Framework replaces polling-based monitoring with real-time event processing. It consumes events from the existing accountability system and triggers intelligent coordination responses.

### Core Components

1. **Event Stream**: `coordination_alerts.json` (existing accountability infrastructure)
2. **Event Consumer**: `scripts/event_driven_coordinator.py` (real-time processor)
3. **Response Engine**: Multi-level escalation with agent communication
4. **Audit Trail**: Crisis logging and response tracking

## Event Types and Response Patterns

### 1. COORDINATION_CRISIS Events

**Pattern**: Critical coordination breakdown requiring immediate intervention

```json
{
  "type": "COORDINATION_CRISIS",
  "task_id": "task-123",
  "agent_id": "unresponsive-agent",
  "escalation_level": "red|orange|yellow",
  "timestamp": "2025-07-16T21:44:26Z",
  "description": "Agent unresponsive for task"
}
```

**Response Procedures**:

- **RED (Critical)**: 
  - Immediate PM agent notification with üö® URGENT flag
  - Direct agent ping with crisis message
  - Emergency task reassignment protocol
  - Crisis event logging for audit
  - Escalation counter increment

- **ORANGE (High)**:
  - Priority PM agent notification 
  - Agent reminder with deadline emphasis
  - Monitoring increase frequency
  - Warning-level logging

- **YELLOW (Medium)**:
  - Standard PM notification
  - Gentle agent reminder
  - Normal monitoring continuation

### 2. DEADLINE_WARNING Events

**Pattern**: Task deadline approaching, proactive intervention

```json
{
  "type": "DEADLINE_WARNING", 
  "task_id": "task-123",
  "agent_id": "working-agent",
  "time_remaining": "30 minutes",
  "timestamp": "2025-07-16T21:44:26Z"
}
```

**Response Procedures**:
- PM agent deadline notification with ‚è∞ flag
- Agent reminder with time remaining
- Priority boost recommendation
- Completion status request

### 3. AGENT_UNRESPONSIVE Events

**Pattern**: Agent not responding to coordination attempts

```json
{
  "type": "AGENT_UNRESPONSIVE",
  "agent_id": "silent-agent", 
  "last_activity": "2025-07-16T20:00:00Z",
  "unresponsive_duration": "1.5 hours",
  "timestamp": "2025-07-16T21:44:26Z"
}
```

**Response Procedures**:
- Health check ping to agent
- PM notification of unresponsive status
- Reassignment consideration trigger
- Activity monitoring increase

### 4. TASK_REASSIGNMENT Events

**Pattern**: Task ownership change due to coordination issues

```json
{
  "type": "TASK_REASSIGNMENT",
  "task_id": "task-123",
  "old_agent": "failed-agent",
  "new_agent": "backup-agent", 
  "reason": "Agent unresponsive",
  "timestamp": "2025-07-16T21:44:26Z"
}
```

**Response Procedures**:
- PM notification of reassignment
- New agent assignment notification
- Handover context transfer
- Old agent status check

## Escalation Procedures

### Escalation Levels

1. **GREEN**: Normal operation, monitoring only
2. **YELLOW**: Warning state, increased monitoring + notifications
3. **ORANGE**: High concern, urgent notifications + direct intervention
4. **RED**: Crisis state, immediate escalation + emergency protocols

### Escalation Triggers

```
Normal ‚Üí WARNING: Deadline < 50% remaining
WARNING ‚Üí HIGH: Deadline < 25% remaining OR agent unresponsive > 30min
HIGH ‚Üí CRISIS: Deadline < 10% remaining OR agent unresponsive > 1hr
CRISIS ‚Üí EMERGENCY: Deadline passed OR agent unresponsive > 2hr
```

### Response Time SLAs

- **GREEN**: Standard monitoring (5min intervals)
- **YELLOW**: Increased monitoring (2min intervals) + notifications within 1min
- **ORANGE**: High frequency monitoring (30sec intervals) + notifications within 30sec  
- **RED**: Real-time monitoring + immediate notifications (<10sec)

## Integration with Phase 1 Completion

### Foundation Epic Phase 1 Event Integration

The event-driven framework integrates with Phase 1 completion through:

1. **Quality Gate Events**: Test failures, build issues trigger coordination events
2. **PR Status Events**: Merge conflicts, CI failures generate escalation
3. **Completion Tracking**: Phase milestones trigger event updates
4. **Evidence Collection**: Automated evidence gathering for completion validation

### Phase 1 Event Stream

```json
{
  "type": "PHASE1_MILESTONE",
  "milestone": "PR #70 XP Quality Gate",
  "status": "failing",
  "blocking_issues": ["import errors", "test failures"],
  "assigned_agent": "performance-agent",
  "timestamp": "2025-07-16T21:44:26Z"
}
```

## Implementation Architecture

### Event Flow

```
Accountability System ‚Üí coordination_alerts.json ‚Üí Event Consumer ‚Üí Response Engine ‚Üí Agent Communication
                                                  ‚Üì
                                              Crisis Logger ‚Üí Audit Trail
```

### Response Engine Logic

```python
async def process_event(event):
    event_type = event.get('type')
    escalation_level = determine_escalation(event)
    
    responses = []
    
    if escalation_level >= CRITICAL:
        responses.extend([
            notify_pm_urgent(event),
            ping_agent_direct(event.agent_id),
            trigger_reassignment(event.task_id),
            log_crisis(event)
        ])
    elif escalation_level >= HIGH:
        responses.extend([
            notify_pm_priority(event),
            remind_agent(event.agent_id),
            increase_monitoring(event.task_id)
        ])
    # ... etc
    
    await asyncio.gather(*responses)
```

### Communication Protocols

**PM Agent Notifications**:
```bash
# Critical events
python3 scripts/fixed_agent_communication.py --agent pm-agent \
  --message "üö® URGENT: Coordination crisis for task-123"

# Standard events  
python3 scripts/fixed_agent_communication.py --agent pm-agent \
  --message "[COORDINATION] Deadline approaching for task-123"
```

**Agent Reminders**:
```bash
# Direct agent communication
python3 scripts/fixed_agent_communication.py --agent working-agent \
  --message "[REMINDER] Task task-123 deadline in 30 minutes"
```

## Usage and Control

### Starting the Event Coordinator

```bash
# Start with default settings
python3 scripts/event_driven_coordinator.py

# Start with custom alerts file
python3 scripts/event_driven_coordinator.py --alerts-file custom_alerts.json

# Test mode with verbose logging
python3 scripts/event_driven_coordinator.py --test-mode
```

### Control Script Usage

```bash
# Start real-time coordination
./scripts/coordination_control.sh start

# Check status and statistics
./scripts/coordination_control.sh status

# View recent events
./scripts/coordination_control.sh events 5

# Generate test event
./scripts/coordination_control.sh test-event

# Stop coordination
./scripts/coordination_control.sh stop
```

### Event API Usage

```python
# Programmatic event consumption
from scripts.coordination_event_api import CoordinationEventConsumer

consumer = CoordinationEventConsumer()

def handle_crisis(event):
    print(f"Crisis: {event.task_id}")

consumer.subscribe("COORDINATION_CRISIS", handle_crisis)

# Start processing
async for event in consumer.stream_events():
    await consumer._process_single_event(event)
```

## Monitoring and Metrics

### Key Metrics Tracked

- Events processed per hour
- Response time (event ‚Üí notification)
- Escalation frequency by type
- Agent responsiveness rates
- Crisis resolution time
- Notification delivery success rate

### Health Indicators

```json
{
  "coordinator_status": "running",
  "uptime": "2h 15m",
  "events_processed": 47,
  "coordination_crises": 3,
  "deadline_warnings": 12,
  "responses_sent": 28,
  "avg_response_time": "0.3s"
}
```

### Audit Trail

All crisis events are logged to `coordination_crisis_log.json`:

```json
{
  "timestamp": "2025-07-16T21:44:26Z",
  "severity": "CRITICAL", 
  "original_event": {...},
  "coordinator_response": "Event processed, PM notified, agent pinged",
  "resolution_time": "45s"
}
```

## Integration Points

### With Existing Systems

1. **Accountability Framework**: Event source and task tracking
2. **Fixed Agent Communication**: Response delivery mechanism  
3. **PM Agent**: Primary coordination recipient
4. **Quality Gates**: Integration with CI/CD pipeline
5. **GitHub Workflows**: PR status and merge coordination

### Future Extensions

1. **Slack Integration**: External notification channels
2. **Dashboard Widgets**: Real-time event visualization
3. **Machine Learning**: Predictive coordination failure detection
4. **Automated Resolution**: Self-healing coordination protocols

## Success Criteria

### Phase 1 Completion Integration

‚úÖ **Event-driven coordination replaces polling**  
‚úÖ **Real-time response to coordination crises**  
‚úÖ **Automated escalation procedures**  
‚úÖ **PM agent integration for oversight**  
‚úÖ **Audit trail for accountability**  
‚úÖ **Crisis resolution tracking**

### Performance Targets

- Event processing latency: <500ms
- Notification delivery: <10s for critical events
- System availability: >99.9%
- Crisis resolution: <5min average
- False positive rate: <5%

## Summary

The Event-Driven Coordination Framework transforms reactive coordination into proactive, intelligent response systems. By consuming events from the existing accountability infrastructure, it provides:

1. **Real-time coordination** instead of polling delays
2. **Intelligent escalation** based on event severity  
3. **Automated response protocols** for common coordination issues
4. **Audit trails** for accountability and improvement
5. **Integration with Phase 1** completion procedures

This framework enables the LeanVibe Agent Hive to maintain coordination at scale while providing human oversight through the PM agent and maintaining complete audit trails for all coordination actions.